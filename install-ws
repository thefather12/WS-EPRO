#!/bin/bash
clear
echo -e "\033[1;36m========================================================\033[0m"
echo -e "\033[1;33m INICIANDO INSTALACIÃ“N Y CORRECCIÃ“N DE WS-EPRO \033[0m"
echo -e "\033[1;36m========================================================\033[0m"
sleep 1

# ==========================================================
# 1. LIMPIEZA Y PREPARACIÃ“N
# ==========================================================
echo -e "\033[1;33m\n[ WS-EPRO ] Limpiando configuraciones anteriores...\033[0m"
pkill -f ws-epro
systemctl stop ws-epro >/dev/null 2>&1
systemctl disable ws-epro >/dev/null 2>&1
systemctl daemon-reload >/dev/null 2>&1
rm -rf /usr/local/etc/ws-epro
mkdir -p /usr/local/etc/ws-epro
cd

# ==========================================================
# 2. DESCARGA DE BINARIOS
# ==========================================================
# Nota: Se mantienen las URLs de Google Drive que confirmaste que funcionan para descargar los binarios.

echo -e "\033[1;32m-> 1/3 Descargando binario ws-epro...\033[0m"
wget -q --show-progress --load-cookies /tmp/cookies.txt "https://docs.google.com/uc?export=download&confirm=$(wget --quiet --save-cookies /tmp/cookies.txt --keep-session-cookies --no-check-certificate 'https://docs.google.com/uc?export=download&id=1IbwfNpKpa1JzvXsDT-WgNpp5nWrklisG' -O- | sed -rn 's/.*confirm=([0-9A-Za-z_]+).*/\1\n/p')&id=1IbwfNpKpa1JzvXsDT-WgNpp5nWrklisG" -O /usr/local/bin/ws-epro && rm -rf /tmp/cookies.txt
chmod +x /usr/local/bin/ws-epro

echo -e "\033[1;32m-> 2/3 Descargando script auxiliar ws-port...\033[0m"
wget -q --show-progress --load-cookies /tmp/cookies.txt "https://docs.google.com/uc?export=download&confirm=$(wget --quiet --save-cookies /tmp/cookies.txt --keep-session-cookies --no-check-certificate 'https://docs.google.com/uc?export=download&id=1h9QvOnXScplGTnfpbJ7KJDn4CDkwUKWa' -O- | sed -rn 's/.*confirm=([0-9A-Za-z_]+).*/\1\n/p')&id=1h9QvOnXScplGTnfpbJ7KJDn4CDkwUKWa" -O /usr/bin/ws-port && rm -rf /tmp/cookies.txt
chmod +x /usr/bin/ws-port

# ==========================================================
# 3. CREACIÃ“N DEL ARCHIVO DE SERVICIO (CORRECCIÃ“N VITAL)
# ==========================================================
echo -e "\033[1;32m-> 3/3 Creando ws-epro.service (corregido)...\033[0m"
# Creamos el archivo de servicio localmente para evitar la corrupciÃ³n de la descarga.
rm -f /etc/systemd/system/ws-epro.service

cat > /etc/systemd/system/ws-epro.service << EOL
[Unit]
Description=WebSocket E-Pro Tunnel
After=network.target

[Service]
User=root
WorkingDirectory=/usr/local/etc/ws-epro
ExecStart=/usr/local/bin/ws-epro -f /usr/local/etc/ws-epro/config.yml  # CORREGIDO: Usando -f
Restart=always
StandardOutput=syslog
StandardError=syslog
SyslogIdentifier=ws-epro

[Install]
WantedBy=multi-user.target
EOL
chmod 644 /etc/systemd/system/ws-epro.service

# ==========================================================
# 4. CONFIGURACIÃ“N DE PUERTOS Y YAML
# ==========================================================
clear
echo -e "\033[1;36m=========================================\033[0m"
echo -e "\033[1;33m CONFIGURACIÃ“N DE PUERTOS WS-EPRO \033[0m"
echo -e "\033[1;36m=========================================\033[0m"
read -p "PUERTO LOCAL SSH (target_port, ej. 22, 444): " openssh
read -p "PUERTO WEBSOCKET (listen_port, ej. 80, 443): " wsopenssh
echo "CONFIGURANDO SERVIDOR ESPERE..."
sleep 0.5

# GeneraciÃ³n del Archivo YAML (CORRECCIÃ“N DE INDENTACIÃ“N)
echo -e "\033[1;32m-> Generando config.yml con sintaxis YAML correcta...\033[0m"
echo "# verbose level 0=info, 1=verbose, 2=very verbose" > /usr/local/etc/ws-epro/config.yml
echo "verbose: 0" >> /usr/local/etc/ws-epro/config.yml
echo "listen:"  >> /usr/local/etc/ws-epro/config.yml
echo "- target_host: 127.0.0.1" >> /usr/local/etc/ws-epro/config.yml 
echo "  target_port: $openssh" >> /usr/local/etc/ws-epro/config.yml 
echo "  listen_port: $wsopenssh" >> /usr/local/etc/ws-epro/config.yml
chmod 644 /usr/local/etc/ws-epro/config.yml

# ==========================================================
# 5. HABILITAR E INICIAR SERVICIO
# ==========================================================
echo -e "\033[1;32m-> Habilitando e iniciando ws-epro...\033[0m"
systemctl daemon-reload
systemctl enable ws-epro >/dev/null 2>&1
systemctl start ws-epro


# ==========================================================
# 6. RESULTADOS FINALES Y VERIFICACIÃ“N
# ==========================================================
sleep 1
clear
LP='\033[1;35m'
NC='\033[0m' 
echo -e "${LP}"
echo    "
â–‘â–ˆâ–ˆâ•—â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–ˆâ–ˆâ•—â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–‘â–‘â–‘â–‘â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘
â–‘â–ˆâ–ˆâ•‘â–‘â–‘â–ˆâ–ˆâ•—â–‘â–‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•â–‘â–‘â–‘â–‘â–‘â–‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—
â–‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–‘â–‘â–ˆâ–ˆâ•‘
â–‘â–‘â–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ•‘â–‘â–‘â•šâ•â•â•â–ˆâ–ˆâ•—â•šâ•â•â•â•â•â–ˆâ–ˆâ•”â•â•â•â•â–‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–‘â–‘â–ˆâ–ˆâ•‘
â–‘â–‘â•šâ–ˆâ–ˆâ•”â•â–‘â•šâ–ˆâ–ˆâ•”â•â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–‘â–‘â–‘â–‘â–‘â–‘â–ˆâ–ˆâ•‘â–‘â–‘â–‘â–‘â–‘â–ˆâ–ˆâ•‘â–‘â–‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•
â–‘â–‘â–‘â•šâ•â•â–‘â–‘â–‘â•šâ•â•â–‘â–‘â•šâ•â•â•â•â•â•â–‘â–‘â–‘â–‘â–‘â–‘â–‘â•šâ•â•â–‘â–‘â–‘â–‘â–‘â•šâ•â•â–‘â–‘â•šâ•â•â–‘â•šâ•â•â•â•â•â–‘"

echo    "ðŸ’™SCRIPT WEBSOCKET CLOUDFLARE SIN PRO E-PRO INSTALADO CON Ã‰XITOðŸ’™"
echo    "â•â•â•â•ðŸ’™ðŸ§‘ðŸ½â€ðŸ’»EDITADO POR THEFATHER12ðŸ§‘ðŸ½â€ðŸ’»ðŸ’™â•â•â•â•"
echo    "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo -e "   Puerto Local SSH: \033[1;33m$openssh\033[1;35m"
echo -e "   Puerto Phyton: \033[1;33m$wsopenssh\033[1;35m"
echo    "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo    ""
echo -e "\033[1;32m--- VERIFICACIÃ“N DEL ESTADO DEL SERVICIO ---\033[0m"
systemctl status ws-epro | grep "Active:"
echo    "---------------------------------------"
echo    "Para cambiar de puerto use el comando: ws-port"
echo -e "${NC}"

# Limpieza de historial y terminaciÃ³n del script
rm -rf install-ws && cat /dev/null > ~/.bash_history && history -c
echo -ne "\n\033[1;31mFINALIZADO!\033[0m\n"

