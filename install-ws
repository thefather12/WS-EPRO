#!/bin/bash
clear
echo -e "\033[1;36m========================================================\033[0m"
echo -e "\033[1;33m INICIANDO INSTALACI√ìN DE WS-EPRO (VERSI√ìN MEJORADA) \033[0m"
echo -e "\033[1;36m========================================================\033[0m"
sleep 1

# 1. LIMPIEZA Y PREPARACI√ìN
pkill -f ws-epro
systemctl stop ws-epro >/dev/null 2>&1
systemctl disable ws-epro >/dev/null 2>&1
systemctl daemon-reload >/dev/null 2>&1
rm -rf /usr/local/etc/ws-epro
mkdir -p /usr/local/etc/ws-epro
cd

# 2. DESCARGA DE BINARIOS (Se asume que estas URLs funcionan para el binario y el helper)
echo -e "\033[1;32m-> 1/3 Descargando binario ws-epro...\033[0m"
wget -q --show-progress --load-cookies /tmp/cookies.txt "https://docs.google.com/uc?export=download&confirm=$(wget --quiet --save-cookies /tmp/cookies.txt --keep-session-cookies --no-check-certificate 'https://docs.google.com/uc?export=download&id=1IbwfNpKpa1JzvXsDT-WgNpp5nWrklisG' -O- | sed -rn 's/.*confirm=([0-9A-Za-z_]+).*/\1\n/p')&id=1IbwfNpKpa1JzvXsDT-WgNpp5nWrklisG" -O /usr/local/bin/ws-epro && rm -rf /tmp/cookies.txt
chmod +x /usr/local/bin/ws-epro

echo -e "\033[1;32m-> 2/3 Descargando script auxiliar ws-port...\033[0m"
wget -q --show-progress --load-cookies /tmp/cookies.txt "https://docs.google.com/uc?export=download&confirm=$(wget --quiet --save-cookies /tmp/cookies.txt --keep-session-cookies --no-check-certificate 'https://docs.google.com/uc?export=download&id=1h9QvOnXScplGTnfpbJ7KJDn4CDkwUKWa' -O- | sed -rn 's/.*confirm=([0-9A-Za-z_]+).*/\1\n/p')&id=1h9QvOnXScplGTnfpbJ7KJDn4CDkwUKWa" -O /usr/bin/ws-port && rm -rf /tmp/cookies.txt
chmod +x /usr/bin/ws-port

# 3. CREACI√ìN DEL ARCHIVO DE SERVICIO (¬°CORRECCI√ìN VITAL!)
echo -e "\033[1;32m-> 3/3 Creando archivo de servicio systemd (ws-epro.service)...\033[0m"
# Eliminamos la descarga y creamos el archivo con sintaxis limpia para evitar el error 'bad-setting'
rm -f /etc/systemd/system/ws-epro.service

cat > /etc/systemd/system/ws-epro.service << EOL
[Unit]
Description=WebSocket E-Pro Tunnel
After=network.target

[Service]
User=root
WorkingDirectory=/usr/local/etc/ws-epro
ExecStart=/usr/local/bin/ws-epro -c /usr/local/etc/ws-epro/config.yml
Restart=always
StandardOutput=syslog
StandardError=syslog
SyslogIdentifier=ws-epro

[Install]
WantedBy=multi-user.target
EOL
chmod 644 /etc/systemd/system/ws-epro.service


# 4. SOLICITUD DE PUERTOS
clear
echo -e "\033[1;36m=========================================\033[0m"
echo -e "\033[1;33m CONFIGURACI√ìN DE PUERTOS \033[0m"
echo -e "\033[1;36m=========================================\033[0m"
read -p "PUERTO LOCAL SSH (ej. 22, 444, 8000): " openssh
read -p "PUERTO WEBSOCKET (ej. 80, 8080, 443): " wsopenssh
echo "CONFIGURANDO SERVIDOR ESPERE..."
sleep 0.5


# 5. GENERACI√ìN DEL ARCHIVO YAML (¬°CORRECCI√ìN DE INDENTACI√ìN!)
echo -e "\033[1;32m-> Generando config.yml con sintaxis YAML correcta...\033[0m"
echo "# verbose level 0=info, 1=verbose, 2=very verbose" > /usr/local/etc/ws-epro/config.yml
echo "verbose: 0" >> /usr/local/etc/ws-epro/config.yml
echo "listen:"  >> /usr/local/etc/ws-epro/config.yml
echo "- target_host: 127.0.0.1" >> /usr/local/etc/ws-epro/config.yml 
echo "  target_port: $openssh" >> /usr/local/etc/ws-epro/config.yml  # <- Indentaci√≥n de 2 espacios
echo "  listen_port: $wsopenssh" >> /usr/local/etc/ws-epro/config.yml # <- Indentaci√≥n de 2 espacios
chmod 644 /usr/local/etc/ws-epro/config.yml


# 6. HABILITAR E INICIAR SERVICIO
echo -e "\033[1;32m-> Habilitando e iniciando servicio...\033[0m"
systemctl daemon-reload
systemctl enable ws-epro >/dev/null 2>&1
systemctl start ws-epro


# 7. SALIDA Y VERIFICACI√ìN
sleep 1
clear
LP='\033[1;35m'
NC='\033[0m' # No Color
echo -e "${LP}"
echo    "
‚ñë‚ñà‚ñà‚ïó‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñà‚ñà‚ïó‚ñë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñë‚ñë‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñë
‚ñë‚ñà‚ñà‚ïë‚ñë‚ñë‚ñà‚ñà‚ïó‚ñë‚ñë‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó
‚ñë‚ïö‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïù‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñë‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë‚ñë‚ñë‚ñà‚ñà‚ïë
‚ñë‚ñë‚ñà‚ñà‚ñà‚ñà‚ïî‚ïê‚ñà‚ñà‚ñà‚ñà‚ïë‚ñë‚ñë‚ïö‚ïê‚ïê‚ïê‚ñà‚ñà‚ïó‚ïö‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïù‚ñë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ñë‚ñë‚ñà‚ñà‚ïë
‚ñë‚ñë‚ïö‚ñà‚ñà‚ïî‚ïù‚ñë‚ïö‚ñà‚ñà‚ïî‚ïù‚ñë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñà‚ñà‚ïë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñà‚ñà‚ïë‚ñë‚ñë‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù
‚ñë‚ñë‚ñë‚ïö‚ïê‚ïù‚ñë‚ñë‚ñë‚ïö‚ïê‚ïù‚ñë‚ñë‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ïö‚ïê‚ïù‚ñë‚ñë‚ñë‚ñë‚ñë‚ïö‚ïê‚ïù‚ñë‚ñë‚ïö‚ïê‚ïù‚ñë‚ïö‚ïê‚ïê‚ïê‚ïê‚ïù‚ñë"

echo    "üíôSCRIPT WEBSOCKET CLOUDFLARE SIN PRO E-PROüíô"
echo    "Creditos A : @THEFATHER12"
echo    "‚ïê‚ïê‚ïê‚ïêüíôüßëüèΩ‚ÄçüíªEDITADO POR THEFATHER12üßëüèΩ‚Äçüíªüíô‚ïê‚ïê‚ïê‚ïê"
echo    "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
echo -e "   Puerto Local SSH: \033[1;33m$openssh\033[1;35m"
echo -e "   Puerto Phyton: \033[1;33m$wsopenssh\033[1;35m"
echo    "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
echo    ""
echo -e "\033[1;32m--- VERIFICACI√ìN DEL ESTADO DEL SERVICIO ---\033[0m"
systemctl status ws-epro | grep "Active:"
echo    "---------------------------------------"
echo    "WEBSOCKET SIN SER PLAN PRO CLOUDFLARE"
echo    "PARA CAMBIAR DE PUERTO USE COMANDO: ws-port"
echo    "---------------------------------------"
echo -e "${NC}"

rm -rf install-ws && cat /dev/null > ~/.bash_history && history -c
echo -ne "\n\033[1;31mENTER \033[1;33mpara entrar al \033[1;32mMENU!\033[0m"; read
menu # Se asume que esta funci√≥n existe en tu entorno de shell
